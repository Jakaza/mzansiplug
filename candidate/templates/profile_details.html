<!DOCTYPE html>
{% load static %}
<html lang="en">

  {% include 'partials/_head.html' %}

  <body class="topics-listing-page" id="top">
    <main>

      {% include 'partials/_candidate_navbar.html' %}

      <header class="site-header d-flex flex-column justify-content-center align-items-center" style="padding: 100px 0 0 0;">
        <div class="container">
          <div class="text-center" >
            <h2 class="mb-3" style="color: white;">Manage Your Account</h2>
            <p class="lead" style="color: white;">Update your personal information, education, work experience and skills.</p>
          </div>
        </div>
      </header>

      <section class="container py-5">
        <div class="row justify-content-center">
          <div class="col-md-10">
            <div class="row g-4">

              <!-- Personal Info -->
<!-- Personal Info -->
<div class="col-md-6">
  <div class="card shadow-sm h-100">
    <div class="card-body">
      <h5 class="card-title">Personal Information</h5>
      <div id="personal-preview">
        <p><strong>Name:</strong> {{ profile.full_name }}</p>
        <p><strong>Phone:</strong> {{ profile.phone }}</p>
        <p><strong>DOB:</strong> {{ profile.dob }}</p>
        <p><strong>Gender:</strong> {{ profile.gender }}</p>
        <button class="btn btn-outline-primary" onclick="togglePersonalForm()">Update</button>
      </div>

      <form id="personal-form" style="display:none;">
        {% csrf_token %}
        <input type="text" name="full_name" class="form-control mb-2" value="{{ profile.full_name }}">
        <input type="text" name="phone" class="form-control mb-2" value="{{ profile.phone }}">
        <input type="date" name="dob" class="form-control mb-2" value="{{ profile.dob }}">
        <select name="gender" class="form-control mb-2">
          <option value="Male" {% if profile.gender == "Male" %}selected{% endif %}>Male</option>
          <option value="Female" {% if profile.gender == "Female" %}selected{% endif %}>Female</option>
        </select>
        <button type="button" class="btn btn-primary" onclick="savePersonalInfo()">Save</button>
        <button type="button" class="btn btn-secondary" onclick="togglePersonalForm()">Cancel</button>
      </form>
    </div>
  </div>
</div>

<script>
function togglePersonalForm() {
  const preview = document.getElementById("personal-preview");
  const form = document.getElementById("personal-form");
  preview.style.display = preview.style.display === "none" ? "block" : "none";
  form.style.display = form.style.display === "none" ? "block" : "none";
}

function savePersonalInfo() {
  const form = document.getElementById("personal-form");
  const formData = new FormData(form);

  fetch("{% url 'update-profile' %}", {
    method: "POST",
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      location.reload();  // or dynamically update preview
    } else {
      alert("Error: " + JSON.stringify(data.errors));
    }
  });
}
</script>


<!-- Education Section -->
<div class="col-md-6">
  <div class="card shadow-sm h-100">
    <div class="card-body">
      <h5 class="card-title">Education</h5>

      <div id="education-list">
        {% for edu in educations %}
          <div class="border rounded p-2 mb-2 bg-light position-relative" id="edu-{{ edu.id }}">
            <p><strong>{{ edu.qualification }}</strong></p>
            <p>{{ edu.institution }}</p>
            <p>{{ edu.start_year }} - {{ edu.end_year|default:"Present" }}</p>
      
            <button type="button"
                    class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2"
                    onclick="deleteEducation({{ edu.id }})">
              &times;
            </button>
          </div>
        {% empty %}
          <p class="text-muted">No education entries yet.</p>
        {% endfor %}
      </div>

      <!-- Toggle Button -->
      <button class="btn btn-outline-primary mt-2" onclick="toggleEduForm()">Add Education</button>

      <!-- Add Form (Hidden Initially) -->
      <div id="edu-form" style="display:none;" class="mt-3">
        <input type="text" class="form-control mb-2" id="edu-qualification" placeholder="Qualification">
        <input type="text" class="form-control mb-2" id="edu-institution" placeholder="Institution">
        <input type="number" class="form-control mb-2" id="edu-start-year" placeholder="Start Year">
        <input type="number" class="form-control mb-2" id="edu-end-year" placeholder="End Year (optional)">

        <button class="btn btn-sm btn-primary" onclick="saveEducation()">Save</button>
        <button class="btn btn-sm btn-secondary" onclick="toggleEduForm()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    function toggleEduForm() {
      const form = document.getElementById("edu-form");
      form.style.display = form.style.display === "none" ? "block" : "none";
    }
  
    function saveEducation() {
      const qualification = document.getElementById("edu-qualification").value;
      const institution = document.getElementById("edu-institution").value;
      const startYear = document.getElementById("edu-start-year").value;
      const endYear = document.getElementById("edu-end-year").value;
  
      const formData = new FormData();
      formData.append("qualification", qualification);
      formData.append("institution", institution);
      formData.append("start_year", startYear);
      formData.append("end_year", endYear);
      formData.append("csrfmiddlewaretoken", '{{ csrf_token }}');
  
      fetch("{% url 'add-education' %}", {
        method: "POST",
        body: formData,
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          location.reload();  // reload to show new item in preview list
        } else {
          alert("Error: " + JSON.stringify(data.errors));
        }
      });
    }


    function deleteEducation(eduId) {
    if (!confirm("Delete this education entry?")) return;

    fetch(`/candidate/profile/education/delete/${eduId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}"
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const eduDiv = document.getElementById(`edu-${eduId}`);
        if (eduDiv) eduDiv.remove();
      } else {
        alert("Error deleting education.");
      }
    });
  }
  </script>
  
</div>



<!-- Work Experience -->
<div class="col-md-6">
  <div class="card shadow-sm h-100">
    <div class="card-body">
      <h5 class="card-title">Work Experience</h5>

      <!-- Preview Existing -->
      {% for exp in experiences %}
      <div class="border rounded p-2 mb-3 bg-light position-relative" id="work-{{ exp.id }}">
        <strong>{{ exp.job_title }}</strong> at {{ exp.company }}<br>
        {{ exp.start_date }} - {{ exp.end_date|default:"Present" }}<br>
        <small>{{ exp.description }}</small>

        
        <!-- Delete Button -->

        <button type="button"
        class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2"
        onclick="deleteWork({{ exp.id }})">
  &times;
</button>

      </div>
    {% empty %}
      <p class="text-muted">No work experience added yet.</p>
    {% endfor %}
    
      <!-- Toggle Button -->
      <button class="btn btn-outline-primary mb-3" onclick="toggleWorkForm()">Add Experience</button>

      <!-- Add Form (Hidden) -->
      <div id="work-form-container" style="display: none;">
        <form id="work-form">
          {% csrf_token %}
          <div class="mb-2">
            <input type="text" name="job_title" class="form-control" placeholder="Job Title" required>
          </div>
          <div class="mb-2">
            <input type="text" name="company" class="form-control" placeholder="Company" required>
          </div>
          <div class="mb-2">
            <input type="date" name="start_date" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="date" name="end_date" class="form-control">
          </div>
          <div class="mb-2">
            <textarea name="description" class="form-control" placeholder="Responsibilities (optional)"></textarea>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">Save</button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="toggleWorkForm()">Cancel</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    function toggleWorkForm() {
      const form = document.getElementById("work-form-container");
      form.style.display = form.style.display === "none" ? "block" : "none";
    }
  
    document.getElementById("work-form").addEventListener("submit", function (e) {
      e.preventDefault();
  
      const form = e.target;
      const formData = new FormData(form);
  
      fetch("{% url 'add-work-experience' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
        },
        body: formData,
      })
      .then(response => response.json())
      .then(data => {
        console.log(data);
        const status = data.status;
        if (status == 'success') {
          location.reload();  // Or use JS to update the DOM without reload
        } else {
          alert("Error saving work experience.");
        }
      });
    });

    function deleteWork(expId) {
    if (!confirm("Delete this work experience?")) return;

    fetch(`/candidate/profile/work/delete/${expId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}"
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const item = document.getElementById(`work-${expId}`);
        if (item) item.remove();
      } else {
        alert("Error deleting work experience.");
      }
    });
  }
  </script>
</div>








<!-- Skills -->
<div class="col-md-6">
  <div class="card shadow-sm h-100">
    <div class="card-body">
      <h5 class="card-title">Skills</h5>

      <!-- Preview Existing Skills -->
      <div id="skills-list">
        {% for skill in skills %}
          <div class="border rounded p-2 mb-2 bg-light d-flex justify-content-between align-items-center" id="skill-{{ skill.id }}">
            <div>
              <strong>{{ skill.name }}</strong> — {{ skill.proficiency }}
            </div>
            <button class="btn btn-sm btn-danger" onclick="deleteSkill({{ skill.id }})" title="Delete">
              &times;
            </button>
          </div>
        {% empty %}
          <p class="text-muted">No skills added yet.</p>
        {% endfor %}
      </div>

      <!-- Toggle Form Button -->
      <button class="btn btn-outline-primary mb-3" onclick="toggleSkillForm()">Add Skill</button>

      <!-- Add Skill Form (Initially Hidden) -->
      <div id="skill-form-container" style="display: none;">
        <form id="skill-form">
          {% csrf_token %}
          <div class="mb-2">
            <input type="text" name="name" class="form-control" placeholder="Skill name (e.g. Python)" required>
          </div>
          <div class="mb-2">
            <select name="proficiency" class="form-control" required>
              <option value="">Select proficiency</option>
              <option value="Beginner">Beginner</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Expert">Expert</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">Save</button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="toggleSkillForm()">Cancel</button>
        </form>
      </div>
    </div>
  </div>
  
  <script>
function toggleSkillForm() {
    const form = document.getElementById("skill-form-container");
    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  document.getElementById("skill-form").addEventListener("submit", function (e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);

    fetch("{% url 'add-skill' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": formData.get("csrfmiddlewaretoken")
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        location.reload(); // OR update the DOM dynamically
      } else {
        alert("Error: " + JSON.stringify(data.errors));
      }
    });
  });
    // Delete skill via AJAX
    function deleteSkill(skillId) {
      if (!confirm("Delete this skill?")) return;
  
      fetch(`/candidate/profile/skill/delete/${skillId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}"
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          const skillDiv = document.getElementById(`skill-${skillId}`);
          if (skillDiv) skillDiv.remove();
        } else {
          alert("Error deleting skill.");
        }
      });
    }
  </script>
  


</div>



            </div>
          </div>
        </div>
      </section>

      {% include 'partials/_footer.html' %}

    </main>
  </body>
</html>
